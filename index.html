<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador Multitarifa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos QRCode.js y jsQR.min.js para el manejo de QR -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- LibrerÃ­as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- TAILWIND CONFIGURATION ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8', /* Lighter Blue for Active Hover */
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1', /* AÃ‘ADIDO */
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            400: '#a3e635', /* Lighter Green for Active Hover */
                            500: '#84cc16',
                            600: '#65a30d',
                            700: '#4d7c0f', /* AÃ‘ADIDO */
                            800: '#3f6212',
                            900: '#365314',
                            'yellow-flash': '#facc15',
                        },
                        // Nuevos colores para asegurar el verde en el flujo de resultados y CTA
                        'cta-green': {
                            500: '#16a34a', /* Usado para los ahorros */
                            600: '#15803d',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base y animaciones */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { border: 2px solid; }

        /* Estilos de los botones de selecciÃ³n de tarifa (Landing Page) */
        .tariff-select-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        
        /* DRK Active Hover Styles (Default) */
        .drk-active .tariff-select-btn:hover {
            border-color: #0ea5e9; /* drk-500 */
            background-color: #f0f9ff; /* drk-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .drk-active .tariff-select-btn:hover .arrow-icon {
            color: #0ea5e9; /* drk-500 */
        }

        /* POWER CUP Active Hover Styles */
        .powercup-active .tariff-select-btn:hover {
            border-color: #84cc16; /* powercup-500 */
            background-color: #f7fee7; /* powercup-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .powercup-active .tariff-select-btn:hover .arrow-icon {
            color: #84cc16; /* powercup-500 */
        }

        .icon-wrapper {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .arrow-icon {
            margin-left: auto;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            transition: color 0.3s ease;
        }

        /* Estilos QR */
        #qr-content-wrapper { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        #qr-content-wrapper.active { max-height: 500px; opacity: 1; }
        #qr-visual-container { 
            position: relative; 
            display: inline-block; 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        /* Texto central del QR */
        #qr-visual-container::before { 
            content: var(--qr-center-text, "DRK"); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; /* TamaÃ±o reducido para no cubrir tanto */
            font-weight: bold; 
            color: #ffffff; 
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 4px 8px; /* Padding reducido */
            border-radius: 6px; 
            z-index: 10; 
            opacity: 0.95; 
            min-width: 60px;
            text-align: center;
        }
        
        /* Ocultar elementos dependiendo del tipo de tarifa */
        .hidden-period { display: none; }
        
        /* Estilos para el campo de pegado temporal (FIX para Ctrl+V) */
        #paste-catcher {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* Oculto por defecto */
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.15s ease-in-out;
            resize: none;
        }

        #paste-catcher.pasting-active {
            width: 200px; 
            height: 100px; 
            opacity: 0.01; /* Debe ser casi transparente, pero no 0 */
            z-index: 1000; /* Siempre visible cuando activo */
            border: 4px dashed var(--qr-border-color, #0ea5e9);
            background-color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 drk-active">

    <!-- Navbar -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                </svg>
                <span id="brand-title" class="text-xl font-bold">DRK</span>
            </div>
            
            <!-- Tariff Type Display Badge (For Single Tariff Mode ONLY)  -->
            <div id="tariff-display-area" class="flex items-center space-x-2 hidden">
                 <span id="tariff-display-label" class="text-sm font-medium">Tarifas Cargadas:</span>
                 <span id="tariff-display-badge" class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">
                     0
                 </span>
                 <div id="loading-status" class="flex items-center space-x-2 hidden">
                     <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                     </svg>
                     <span class="text-sm">Cargando...</span>
                 </div>
            </div>
            
            <!-- MULTICUPS SAGA Display (For MULTICUPS Mode ONLY)  -->
            <div id="multicups-saga-display-area" class="flex items-center space-x-3 hidden">
                <div id="loading-status-saga" class="flex items-center space-x-2 hidden">
                    <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm">Cargando Tarifas...</span>
                </div>
                
                <span class="text-sm font-medium">Suministros Agregados:</span>
                <span id="multicups-saga-count" class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                
                <button id="multicups-saga-add-supply-btn" onclick="showSupplyInputMethodSelection()" class="bg-white text-drk-900 hover:bg-drk-100 px-4 py-1.5 rounded-lg text-sm font-semibold transition-all shadow-md flex items-center space-x-2 hidden">
                    <span>âž•</span>
                    <span>AÃ±adir Suministro</span>
                </button>
                
                <button id="multicups-saga-compare-btn" onclick="performMultiCupsSagaComparison()" class="bg-cta-green-500 text-white hover:bg-cta-green-600 px-4 py-1.5 rounded-lg text-sm font-semibold transition-all shadow-md flex items-center space-x-2 hidden">
                    <span>ðŸ“Š</span>
                    <span>Comparar Todos</span>
                </button>
            </div>
            
            <button id="mode-toggle-btn" onclick="toggleMode()" class="p-2 rounded-lg transition-colors hover:bg-white/10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="flex-1 max-w-6xl w-full mx-auto p-4 md:p-6">
        <!-- Landing Page (Initial View) -->
        <div id="landing-page" class="animate-fade-in-up">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-drk-600 to-drk-900 bg-clip-text text-transparent transition-all duration-300">
                    Comparador de Tarifas ElÃ©ctricas
                </h1>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                    Encuentra la mejor tarifa para tu consumo elÃ©ctrico. Elige el tipo de tarifa que deseas comparar.
                </p>
            </div>

            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <!-- Tarifa 2.0TD -->
                <button onclick="selectTariffType('2.0TD')" class="tariff-select-btn group">
                    <div class="icon-wrapper bg-drk-100 group-hover:bg-drk-200">
                        <svg class="w-8 h-8 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Tarifa 2.0TD</h3>
                        <p class="text-sm text-slate-600">Hogares y pequeÃ±os negocios</p>
                        <p class="text-xs text-slate-500 mt-1">Hasta 15 kW de potencia</p>
                    </div>
                    <span class="arrow-icon">â†’</span>
                </button>

                <!-- Tarifa 3.0TD -->
                <button onclick="selectTariffType('3.0TD')" class="tariff-select-btn group">
                    <div class="icon-wrapper bg-amber-100 group-hover:bg-amber-200">
                        <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Tarifa 3.0TD</h3>
                        <p class="text-sm text-slate-600">Empresas y grandes consumos</p>
                        <p class="text-xs text-slate-500 mt-1">MÃ¡s de 15 kW de potencia</p>
                    </div>
                    <span class="arrow-icon">â†’</span>
                </button>

                <!-- Multi CUPS -->
                <button onclick="selectTariffType('MULTICUPS')" class="tariff-select-btn group">
                    <div class="icon-wrapper bg-purple-100 group-hover:bg-purple-200">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Multi CUPS</h3>
                        <p class="text-sm text-slate-600">MÃºltiples suministros</p>
                        <p class="text-xs text-slate-500 mt-1">Gestiona varios CUPS</p>
                    </div>
                    <span class="arrow-icon">â†’</span>
                </button>
            </div>

            <!-- Mode Toggle Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Modo de VisualizaciÃ³n</h3>
                <div class="flex gap-4 justify-center">
                    <button onclick="setDisplayMode('DRK')" class="mode-selector px-6 py-3 rounded-lg font-semibold transition-all border-drk-500 bg-drk-500 text-white">
                        DRK Mode
                    </button>
                    <button onclick="setDisplayMode('POWERCUP')" class="mode-selector px-6 py-3 rounded-lg font-semibold transition-all border-slate-300 bg-white text-slate-700 hover:border-powercup-500">
                        PowerCup Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App Content (Hidden Initially) -->
        <div id="main-app" class="hidden">
            <!-- Back Button -->
            <button onclick="returnToLanding()" class="mb-4 flex items-center space-x-2 text-drk-600 hover:text-drk-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span class="font-medium">Volver al inicio</span>
            </button>

            <!-- Input Method Selection -->
            <div id="input-method-selection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-6 text-center">Â¿CÃ³mo quieres ingresar los datos?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Manual Input Option -->
                    <button onclick="selectInputMethod('manual')" class="p-6 rounded-xl border-2 border-slate-200 hover:border-drk-500 hover:bg-drk-50 transition-all group">
                        <div class="flex flex-col items-center space-y-3">
                            <div class="p-4 rounded-full bg-drk-100 group-hover:bg-drk-200 transition-colors">
                                <svg class="w-10 h-10 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold">Entrada Manual</h3>
                            <p class="text-slate-600 text-center">Ingresa los datos de tu factura manualmente</p>
                        </div>
                    </button>

                    <!-- QR Scan Option -->
                    <button onclick="selectInputMethod('qr')" class="p-6 rounded-xl border-2 border-slate-200 hover:border-drk-500 hover:bg-drk-50 transition-all group">
                        <div class="flex flex-col items-center space-y-3">
                            <div class="p-4 rounded-full bg-drk-100 group-hover:bg-drk-200 transition-colors">
                                <svg class="w-10 h-10 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold">Escanear QR</h3>
                            <p class="text-slate-600 text-center">Escanea el cÃ³digo QR de tu factura</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Manual Input Form -->
            <div id="manual-input-form" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Datos de tu Suministro</h2>
                    <button onclick="showInputMethodSelection()" class="text-slate-600 hover:text-slate-800 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="supply-form" class="space-y-6">
                    <!-- CUPS -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">CUPS (CÃ³digo del Punto de Suministro)</label>
                        <input type="text" id="input-cups" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="ES0000000000000000XX">
                    </div>

                    <!-- Importe Total y DÃ­as Facturados -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Importe Total (â‚¬)</label>
                            <input type="number" step="0.01" id="input-importe" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="150.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">DÃ­as Facturados</label>
                            <input type="number" id="input-dias" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="30">
                        </div>
                    </div>

                    <!-- Potencia Contratada (2.0TD) -->
                    <div id="potencia-2-0-section">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Potencia Contratada (kW)</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P1 (Punta)</label>
                                <input type="number" step="0.001" id="input-potencia-p1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P2 (Valle)</label>
                                <input type="number" step="0.001" id="input-potencia-p2" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                        </div>
                    </div>

                    <!-- Potencia Contratada (3.0TD) -->
                    <div id="potencia-3-0-section" class="hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Potencia Contratada (kW)</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P1</label>
                                <input type="number" step="0.001" id="input-potencia-30-p1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P2</label>
                                <input type="number" step="0.001" id="input-potencia-30-p2" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P3</label>
                                <input type="number" step="0.001" id="input-potencia-30-p3" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P4</label>
                                <input type="number" step="0.001" id="input-potencia-30-p4" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P5</label>
                                <input type="number" step="0.001" id="input-potencia-30-p5" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P6</label>
                                <input type="number" step="0.001" id="input-potencia-30-p6" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                        </div>
                    </div>

                    <!-- EnergÃ­a Consumida (2.0TD) -->
                    <div id="energia-2-0-section">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">EnergÃ­a Consumida (kWh)</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Punta</label>
                                <input type="number" step="0.001" id="input-consumo-punta" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Llano</label>
                                <input type="number" step="0.001" id="input-consumo-llano" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Valle</label>
                                <input type="number" step="0.001" id="input-consumo-valle" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                        </div>
                    </div>

                    <!-- EnergÃ­a Consumida (3.0TD) -->
                    <div id="energia-3-0-section" class="hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">EnergÃ­a Consumida (kWh)</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P1</label>
                                <input type="number" step="0.001" id="input-consumo-30-p1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P2</label>
                                <input type="number" step="0.001" id="input-consumo-30-p2" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P3</label>
                                <input type="number" step="0.001" id="input-consumo-30-p3" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P4</label>
                                <input type="number" step="0.001" id="input-consumo-30-p4" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P5</label>
                                <input type="number" step="0.001" id="input-consumo-30-p5" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">P6</label>
                                <input type="number" step="0.001" id="input-consumo-30-p6" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-drk-500 focus:outline-none transition-colors" placeholder="0.000">
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex gap-4">
                        <button type="button" onclick="submitManualForm()" class="flex-1 bg-drk-600 text-white py-4 rounded-xl font-bold hover:bg-drk-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            Comparar Tarifas
                        </button>
                    </div>
                </form>
            </div>

            <!-- QR Input Section -->
            <div id="qr-input-section" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Escanear CÃ³digo QR</h2>
                    <button onclick="showInputMethodSelection()" class="text-slate-600 hover:text-slate-800 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- QR Scan Options -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <button onclick="startQRCamera()" class="p-4 rounded-xl border-2 border-drk-200 hover:border-drk-500 hover:bg-drk-50 transition-all flex flex-col items-center space-y-2">
                        <svg class="w-8 h-8 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="font-semibold">Usar CÃ¡mara</span>
                    </button>

                    <button onclick="uploadQRImage()" class="p-4 rounded-xl border-2 border-drk-200 hover:border-drk-500 hover:bg-drk-50 transition-all flex flex-col items-center space-y-2">
                        <svg class="w-8 h-8 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="font-semibold">Subir Imagen</span>
                    </button>

                    <button onclick="focusPasteCatcher()" class="p-4 rounded-xl border-2 border-drk-200 hover:border-drk-500 hover:bg-drk-50 transition-all flex flex-col items-center space-y-2">
                        <svg class="w-8 h-8 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="font-semibold">Pegar QR</span>
                    </button>
                </div>

                <!-- QR Camera View -->
                <div id="qr-camera-view" class="hidden mb-6">
                    <div id="interactive" class="viewport bg-slate-100 rounded-xl overflow-hidden"></div>
                    <div class="mt-4 flex gap-4">
                        <button onclick="stopQRCamera()" class="flex-1 bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition-colors">
                            Detener CÃ¡mara
                        </button>
                    </div>
                </div>

                <!-- File Input (Hidden) -->
                <input type="file" id="qr-file-input" accept="image/*" class="hidden" onchange="handleQRImageUpload(event)">
                
                <!-- Paste Catcher (MEJORADO FIX) -->
                <textarea id="paste-catcher" placeholder="Presiona Ctrl+V para pegar"></textarea>

                <!-- QR Status Messages -->
                <div id="qr-status" class="hidden p-4 rounded-xl mb-4"></div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="hidden">
                <!-- Results Header -->
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">Resultados de la ComparaciÃ³n</h2>
                        <div class="flex gap-2">
                            <button onclick="generateQR()" class="px-4 py-2 bg-drk-600 text-white rounded-lg hover:bg-drk-700 transition-colors flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                <span>Generar QR</span>
                            </button>
                            <button onclick="exportToPDF()" class="px-4 py-2 bg-cta-red-500 text-white rounded-lg hover:bg-cta-red-600 transition-colors flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                <span>Descargar PDF</span>
                            </button>
                            <button onclick="resetApp()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                                Nueva ComparaciÃ³n
                            </button>
                        </div>
                    </div>

                    <!-- Current Supply Info -->
                    <div class="grid md:grid-cols-4 gap-4 p-4 bg-slate-50 rounded-xl">
                        <div>
                            <p class="text-sm text-slate-600">CUPS</p>
                            <p id="result-cups" class="font-semibold text-slate-800">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Importe Actual</p>
                            <p id="result-current-cost" class="font-semibold text-slate-800">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Consumo Total</p>
                            <p id="result-total-consumption" class="font-semibold text-slate-800">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">DÃ­as Facturados</p>
                            <p id="result-billing-days" class="font-semibold text-slate-800">-</p>
                        </div>
                    </div>
                </div>

                <!-- QR Display Section -->
                <div id="qr-content-wrapper" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col items-center">
                        <h3 class="text-xl font-bold mb-4">Tu CÃ³digo QR</h3>
                        <div id="qr-visual-container">
                            <div id="qrcode"></div>
                        </div>
                        <p class="text-sm text-slate-600 mt-4 text-center max-w-md">
                            Comparte este cÃ³digo QR para transferir tus datos de consumo fÃ¡cilmente
                        </p>
                    </div>
                </div>

                <!-- Tariff Comparison Cards -->
                <div id="tariff-cards-container" class="space-y-4">
                    <!-- Cards will be generated dynamically -->
                </div>
            </div>

            <!-- MultiCups Saga View -->
            <div id="multicups-saga-view" class="hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">GestiÃ³n de MÃºltiples Suministros</h2>
                    <p class="text-slate-600 mb-4">Agrega todos tus suministros para compararlos conjuntamente</p>
                    
                    <!-- Supplies List -->
                    <div id="multicups-supplies-list" class="space-y-3 mb-6">
                        <!-- Supplies will be added here dynamically -->
                    </div>
                </div>

                <!-- MultiCups Results -->
                <div id="multicups-results-container" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Resultados MultiCups</h2>
                            <div class="flex gap-2">
                                <button onclick="exportMultiCupsToPDF()" class="px-4 py-2 bg-cta-red-500 text-white rounded-lg hover:bg-cta-red-600 transition-colors flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <span>Descargar PDF</span>
                                </button>
                                <button onclick="resetMultiCupsSaga()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                                    Reiniciar
                                </button>
                            </div>
                        </div>

                        <!-- Summary Section -->
                        <div class="grid md:grid-cols-3 gap-4 p-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl mb-6">
                            <div class="text-center">
                                <p class="text-sm text-slate-600 mb-1">Total Suministros</p>
                                <p id="multi-total-supplies" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-slate-600 mb-1">Coste Actual Total</p>
                                <p id="multi-current-total" class="text-3xl font-bold text-slate-800">0.00â‚¬</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-slate-600 mb-1">Ahorro Potencial</p>
                                <p id="multi-savings-total" class="text-3xl font-bold text-cta-green-500">0.00â‚¬</p>
                            </div>
                        </div>

                        <!-- Best Offer Card -->
                        <div id="multicups-best-offer-card" class="bg-gradient-to-br from-cta-green-500 to-cta-green-600 text-white rounded-2xl shadow-xl p-6 mb-6">
                            <!-- Will be filled dynamically -->
                        </div>

                        <!-- Individual Supply Results -->
                        <div id="multicups-individual-results" class="space-y-6">
                            <!-- Individual results will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-fade-in-up">
            <div class="flex items-center space-x-3 mb-4">
                <div class="p-3 bg-red-100 rounded-full">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Error</h3>
            </div>
            <p id="error-message" class="text-slate-600 mb-6">Ha ocurrido un error.</p>
            <button onclick="closeErrorModal()" class="w-full bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition-colors">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-fade-in-up">
            <div class="flex items-center space-x-3 mb-4">
                <div class="p-3 bg-green-100 rounded-full">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Ã‰xito</h3>
            </div>
            <p id="success-message" class="text-slate-600 mb-6">OperaciÃ³n completada correctamente.</p>
            <button onclick="closeSuccessModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors">
                Continuar
            </button>
        </div>
    </div>

    <!-- Offer Decision Modal (New) -->
    <div id="offer-decision-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 animate-fade-in-up max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Selecciona las ofertas a comparar</h3>
            <p class="text-slate-600 mb-6">
                Hay <span id="offer-count-text" class="font-bold">0</span> ofertas disponibles. Â¿Deseas compararlas todas o solo las ofertas DRK?
            </p>
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <button onclick="chooseAllOffers()" class="p-6 rounded-xl border-2 border-slate-300 hover:border-drk-500 hover:bg-drk-50 transition-all group">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-12 h-12 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <h4 class="text-lg font-bold">Todas las Ofertas</h4>
                        <p class="text-sm text-slate-600 text-center">Comparar con el mercado completo</p>
                        <p id="all-offers-count" class="text-2xl font-bold text-drk-600">0</p>
                    </div>
                </button>

                <button onclick="chooseDrkOffersOnly()" class="p-6 rounded-xl border-2 border-slate-300 hover:border-drk-500 hover:bg-drk-50 transition-all group">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-12 h-12 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <h4 class="text-lg font-bold">Solo Ofertas DRK</h4>
                        <p class="text-sm text-slate-600 text-center">Comparar Ãºnicamente con DRK</p>
                        <p id="drk-offers-count" class="text-2xl font-bold text-drk-600">0</p>
                    </div>
                </button>
            </div>

            <button onclick="closeOfferDecisionModal()" class="w-full bg-slate-300 text-slate-700 py-3 rounded-xl font-semibold hover:bg-slate-400 transition-colors">
                Cancelar
            </button>
        </div>
    </div>

    <script>
        // ===========================
        // GLOBAL STATE & CONFIGURATION
        // ===========================
        
        // Current App State
        let currentDisplayMode = 'DRK'; // or 'POWERCUP'
        let currentTariffType = null; // '2.0TD', '3.0TD', 'MULTICUPS'
        let currentInputMethod = null; // 'manual', 'qr'
        let currentTariffs = {'2.0TD': [], '3.0TD': []};
        let lastComparisonResult = null;
        let lastRawData = null;
        
        // MultiCups Saga State
        let multiCupsSupplies = [];
        let multiCupsBestOffersPerSupply = []; // Will hold the best offer for each supply
        let selectedOfferSet = 'ALL'; // 'ALL' or 'DRK_ONLY' - tracks user choice
        
        // Available Offers (populated after user chooses)
        let availableOffers = [];

        // Google Sheets Configuration
        const TARIFF_CONFIG = {
            '2.0TD': {
                sheetId: '10j9VlhJvO2kk5o4RJPW4ZwW5ebQJJIyEZLZXtNwA70w',
                energyPeriods: ['punta', 'llano', 'valle'],
                powerPeriods: ['p1', 'p2']
            },
            '3.0TD': {
                sheetId: '15eSR7Rk4fQwdQKJGXJMFf8Ai0NVRRUxq84MmqtZ4LHQ',
                energyPeriods: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'],
                powerPeriods: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6']
            }
        };

        // QuaggaJS Config (for QR scanning)
        let quaggaInitialized = false;

        // ===========================
        // INITIALIZATION
        // ===========================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            // Set initial mode
            setDisplayMode('DRK');
            
            // Add paste event listener to the paste-catcher
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.addEventListener('paste', handleQRPaste);
            
            // Add blur event to hide paste-catcher when it loses focus
            pasteCatcher.addEventListener('blur', function() {
                this.classList.remove('pasting-active');
            });
        });

        // ===========================
        // MODE MANAGEMENT
        // ===========================
        
        function setDisplayMode(mode) {
            currentDisplayMode = mode;
            const body = document.body;
            const navbar = document.getElementById('navbar');
            const brandTitle = document.getElementById('brand-title');
            
            // Update body classes
            if (mode === 'DRK') {
                body.classList.remove('powercup-active');
                body.classList.add('drk-active');
                navbar.className = 'w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300';
                brandTitle.textContent = 'DRK';
                document.getElementById('app-title').textContent = 'DRK: Comparador Multitarifa';
            } else {
                body.classList.remove('drk-active');
                body.classList.add('powercup-active');
                navbar.className = 'w-full bg-powercup-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300';
                brandTitle.textContent = 'PowerCup';
                document.getElementById('app-title').textContent = 'PowerCup: Comparador Multitarifa';
            }
            
            // Update mode selector buttons
            updateModeButtons();
            
            // Update QR border color
            updateQRStyling();
        }
        
        function toggleMode() {
            setDisplayMode(currentDisplayMode === 'DRK' ? 'POWERCUP' : 'DRK');
        }
        
        function updateModeButtons() {
            const buttons = document.querySelectorAll('.mode-selector');
            buttons.forEach(btn => {
                const isDrk = btn.textContent.includes('DRK');
                if ((isDrk && currentDisplayMode === 'DRK') || (!isDrk && currentDisplayMode === 'POWERCUP')) {
                    if (currentDisplayMode === 'DRK') {
                        btn.className = 'mode-selector px-6 py-3 rounded-lg font-semibold transition-all border-drk-500 bg-drk-500 text-white';
                    } else {
                        btn.className = 'mode-selector px-6 py-3 rounded-lg font-semibold transition-all border-powercup-500 bg-powercup-500 text-white';
                    }
                } else {
                    btn.className = 'mode-selector px-6 py-3 rounded-lg font-semibold transition-all border-slate-300 bg-white text-slate-700 hover:border-' + (currentDisplayMode === 'DRK' ? 'drk' : 'powercup') + '-500';
                }
            });
        }
        
        function updateQRStyling() {
            const qrContainer = document.getElementById('qr-visual-container');
            const pasteCatcher = document.getElementById('paste-catcher');
            
            if (currentDisplayMode === 'DRK') {
                qrContainer.style.setProperty('--qr-border-color', '#0ea5e9'); // drk-500
                qrContainer.style.setProperty('--qr-center-bg', '#0c4a6e'); // drk-900
                qrContainer.style.setProperty('--qr-center-text', '"DRK"');
                pasteCatcher.style.borderColor = '#0ea5e9';
            } else {
                qrContainer.style.setProperty('--qr-border-color', '#84cc16'); // powercup-500
                qrContainer.style.setProperty('--qr-center-bg', '#365314'); // powercup-900
                qrContainer.style.setProperty('--qr-center-text', '"PC"');
                pasteCatcher.style.borderColor = '#84cc16';
            }
        }

        // ===========================
        // TARIFF TYPE SELECTION
        // ===========================
        
        async function selectTariffType(type) {
            currentTariffType = type;
            
            // Hide landing page
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            if (type === 'MULTICUPS') {
                // MULTICUPS MODE: Fetch both tariffs, show MULTICUPS Saga View
                updateMultiCupsSagaView();
                showMultiCupsSagaView();
                await fetchTariffsForMultiCups();
            } else {
                // SINGLE TARIFF MODE: Fetch the specific tariff, show normal input method selection
                updateSingleTariffBadge();
                showInputMethodSelection();
                await fetchTariffsFromSheet(type);
                
                // Update form visibility based on tariff type
                updateFormVisibility();
            }
        }
        
        function updateFormVisibility() {
            const is2TD = currentTariffType === '2.0TD';
            
            // Toggle power sections
            document.getElementById('potencia-2-0-section').classList.toggle('hidden', !is2TD);
            document.getElementById('potencia-3-0-section').classList.toggle('hidden', is2TD);
            
            // Toggle energy sections
            document.getElementById('energia-2-0-section').classList.toggle('hidden', !is2TD);
            document.getElementById('energia-3-0-section').classList.toggle('hidden', is2TD);
        }

        function returnToLanding() {
            // Reset state
            currentTariffType = null;
            currentInputMethod = null;
            
            // Reset MultiCups if it was active
            if (document.getElementById('multicups-saga-view').classList.contains('hidden') === false) {
                resetMultiCupsSaga();
            }
            
            // Hide main app
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('landing-page').classList.remove('hidden');
            
            // Hide all sections
            document.getElementById('input-method-selection').classList.add('hidden');
            document.getElementById('manual-input-form').classList.add('hidden');
            document.getElementById('qr-input-section').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden');
        }

        // ===========================
        // INPUT METHOD SELECTION
        // ===========================
        
        function showInputMethodSelection() {
            document.getElementById('input-method-selection').classList.remove('hidden');
            document.getElementById('manual-input-form').classList.add('hidden');
            document.getElementById('qr-input-section').classList.add('hidden');
        }
        
        function selectInputMethod(method) {
            currentInputMethod = method;
            document.getElementById('input-method-selection').classList.add('hidden');
            
            if (method === 'manual') {
                document.getElementById('manual-input-form').classList.remove('hidden');
            } else if (method === 'qr') {
                document.getElementById('qr-input-section').classList.remove('hidden');
            }
        }

        // ===========================
        // MANUAL INPUT HANDLING
        // ===========================
        
        function submitManualForm() {
            const tariffType = currentTariffType;
            const config = TARIFF_CONFIG[tariffType];
            
            // Collect form data
            const data = {
                cups: document.getElementById('input-cups').value.trim(),
                importe_total: parseFloat(document.getElementById('input-importe').value) || 0,
                dias_facturados: parseInt(document.getElementById('input-dias').value) || 30
            };
            
            // Validate CUPS
            if (!data.cups) {
                showErrorModal('Por favor, ingresa el CUPS');
                return;
            }
            
            // Collect power data
            if (tariffType === '2.0TD') {
                data.potencia_p1_kw = parseFloat(document.getElementById('input-potencia-p1').value) || 0;
                data.potencia_p2_kw = parseFloat(document.getElementById('input-potencia-p2').value) || 0;
            } else {
                for (let i = 1; i <= 6; i++) {
                    data[`potencia_p${i}_kw`] = parseFloat(document.getElementById(`input-potencia-30-p${i}`).value) || 0;
                }
            }
            
            // Collect consumption data
            if (tariffType === '2.0TD') {
                data.consumo_punta = parseFloat(document.getElementById('input-consumo-punta').value) || 0;
                data.consumo_llano = parseFloat(document.getElementById('input-consumo-llano').value) || 0;
                data.consumo_valle = parseFloat(document.getElementById('input-consumo-valle').value) || 0;
            } else {
                for (let i = 1; i <= 6; i++) {
                    data[`consumo_p${i}`] = parseFloat(document.getElementById(`input-consumo-30-p${i}`).value) || 0;
                }
            }
            
            // Validate that at least one consumption value is > 0
            const consumptionValues = Object.keys(data)
                .filter(k => k.startsWith('consumo'))
                .map(k => data[k]);
            
            if (!consumptionValues.some(v => v > 0)) {
                showErrorModal('Por favor, ingresa al menos un valor de consumo');
                return;
            }
            
            // Store raw data for QR generation
            lastRawData = {...data};
            
            // Process comparison
            processComparison(data);
        }

        // ===========================
        // QR HANDLING
        // ===========================
        
        function startQRCamera() {
            const cameraView = document.getElementById('qr-camera-view');
            cameraView.classList.remove('hidden');
            
            if (!quaggaInitialized) {
                // Note: For QR codes, we'd need jsQR instead of QuaggaJS
                // This is a placeholder - actual implementation would use getUserMedia + jsQR
                initQRScanner();
            }
        }
        
        function stopQRCamera() {
            document.getElementById('qr-camera-view').classList.add('hidden');
            if (quaggaInitialized) {
                // Stop camera
                const video = document.querySelector('#interactive video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            }
        }
        
        function uploadQRImage() {
            document.getElementById('qr-file-input').click();
        }
        
        function handleQRImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                decodeQRFromImage(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function focusPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.classList.add('pasting-active');
            pasteCatcher.focus();
            showQRStatus('Presiona Ctrl+V para pegar la imagen del QR', 'info');
        }
        
        function handleQRPaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        showQRStatus('Imagen detectada, decodificando...', 'info');
                        decodeQRFromImage(e.target.result);
                    };
                    
                    reader.readAsDataURL(blob);
                    event.preventDefault();
                    return;
                }
            }
            
            showQRStatus('No se detectÃ³ ninguna imagen. Por favor, copia una imagen QR.', 'error');
        }
        
        function decodeQRFromImage(imageSrc) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    showQRStatus('Â¡QR detectado! Procesando datos...', 'success');
                    processQRData(code.data);
                    
                    // Hide paste-catcher after successful scan
                    document.getElementById('paste-catcher').classList.remove('pasting-active');
                } else {
                    showQRStatus('No se pudo leer el cÃ³digo QR. Intenta con otra imagen.', 'error');
                }
            };
            img.src = imageSrc;
        }
        
        function initQRScanner() {
            // This would use getUserMedia + jsQR for real-time scanning
            // Simplified placeholder
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    
                    const interactive = document.getElementById('interactive');
                    interactive.innerHTML = '';
                    interactive.appendChild(video);
                    
                    quaggaInitialized = true;
                    scanQRFromVideo(video);
                })
                .catch(function(err) {
                    showErrorModal('No se pudo acceder a la cÃ¡mara: ' + err.message);
                });
        }
        
        function scanQRFromVideo(video) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        showQRStatus('Â¡QR detectado! Procesando datos...', 'success');
                        processQRData(code.data);
                        stopQRCamera();
                        return;
                    }
                }
                
                requestAnimationFrame(tick);
            }
            
            requestAnimationFrame(tick);
        }
        
        function processQRData(qrData) {
            try {
                const data = JSON.parse(qrData);
                
                // Validate data structure
                if (!data.cups) {
                    throw new Error('Datos QR invÃ¡lidos: falta CUPS');
                }
                
                // Store raw data
                lastRawData = {...data};
                
                // Auto-detect tariff type if not set or if MULTICUPS
                if (!currentTariffType || currentTariffType === 'MULTICUPS') {
                    // Detect based on presence of fields
                    if (data.consumo_punta !== undefined) {
                        currentTariffType = '2.0TD';
                    } else if (data.consumo_p1 !== undefined) {
                        currentTariffType = '3.0TD';
                    } else {
                        throw new Error('No se pudo determinar el tipo de tarifa del QR');
                    }
                    
                    // If we're in MULTICUPS mode and detected a type, we need to handle it differently
                    if (document.getElementById('multicups-saga-view').classList.contains('hidden') === false) {
                        // We're in MultiCups mode, process this as a supply addition
                        processComparison(data);
                        return;
                    }
                }
                
                showSuccessModal('Datos cargados correctamente desde el QR');
                processComparison(data);
                
            } catch (error) {
                console.error('Error processing QR:', error);
                showErrorModal('Error al procesar el cÃ³digo QR: ' + error.message);
            }
        }
        
        function showQRStatus(message, type) {
            const statusEl = document.getElementById('qr-status');
            statusEl.textContent = message;
            statusEl.className = 'p-4 rounded-xl mb-4';
            
            if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            statusEl.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 3000);
        }
        
        function generateQR() {
            if (!lastRawData) {
                showErrorModal('No hay datos para generar el QR');
                return;
            }
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous QR
            
            const qrData = JSON.stringify(lastRawData);
            
            new QRCode(qrContainer, {
                text: qrData,
                width: 256,
                height: 256,
                colorDark: currentDisplayMode === 'DRK' ? '#0c4a6e' : '#365314',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Show QR section with animation
            const wrapper = document.getElementById('qr-content-wrapper');
            wrapper.classList.add('active');
            
            // Scroll to QR
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ===========================
        // COMPARISON LOGIC
        // ===========================
        
        function processComparison(data) {
            // Determine tariff type from data if not explicitly set
            const tariffType = currentTariffType;
            
            if (!tariffType) {
                showErrorModal('Tipo de tarifa no especificado');
                return;
            }
            
            // Get available tariffs
            const tariffs = currentTariffs[tariffType];
            
            if (!tariffs || tariffs.length === 0) {
                showErrorModal('No hay tarifas cargadas para comparar');
                return;
            }
            
            // Calculate costs for each tariff
            const results = tariffs.map(tariff => {
                const cost = calculateTariffCost(data, tariff, tariffType);
                return {
                    ...tariff,
                    calculated_cost: cost,
                    savings: data.importe_total - cost,
                    savings_percentage: ((data.importe_total - cost) / data.importe_total * 100)
                };
            });
            
            // Sort by calculated cost (lowest first)
            results.sort((a, b) => a.calculated_cost - b.calculated_cost);
            
            // Store results
            lastComparisonResult = {
                supply_data: data,
                results: results,
                tariffType: tariffType,
                isMulti: false
            };
            
            // Check if we're in MULTICUPS mode
            if (currentTariffType === 'MULTICUPS' || document.getElementById('multicups-saga-view').classList.contains('hidden') === false) {
                // MULTICUPS: Add this supply to the list
                saveSupply(data, results);
            } else {
                // SINGLE MODE: Show results immediately
                displayResults();
            }
        }
        
        function calculateTariffCost(supply, tariff, tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            let totalCost = 0;
            
            // Calculate power costs
            config.powerPeriods.forEach(period => {
                const powerKey = `potencia_${period}_kw`;
                const priceKey = `${period}_potencia`;
                const power = supply[powerKey] || 0;
                const price = tariff[priceKey] || 0;
                totalCost += power * price * (supply.dias_facturados || 30);
            });
            
            // Calculate energy costs
            config.energyPeriods.forEach(period => {
                let consumptionKey, priceKey;
                
                if (tariffType === '2.0TD') {
                    consumptionKey = `consumo_${period}`;
                    priceKey = `${period}_price`;
                } else {
                    consumptionKey = `consumo_${period}`;
                    priceKey = `${period}_price`;
                }
                
                const consumption = supply[consumptionKey] || 0;
                const price = tariff[priceKey] || 0;
                totalCost += consumption * price;
            });
            
            // Apply discount if present
            const discount = tariff.descuento || 0;
            if (discount > 0) {
                totalCost = totalCost * (1 - discount / 100);
            }
            
            return totalCost;
        }
        
        function displayResults() {
            // Hide input sections
            document.getElementById('input-method-selection').classList.add('hidden');
            document.getElementById('manual-input-form').classList.add('hidden');
            document.getElementById('qr-input-section').classList.add('hidden');
            
            // Show results section
            document.getElementById('results-view').classList.remove('hidden');
            
            const result = lastComparisonResult;
            
            // Display supply info
            document.getElementById('result-cups').textContent = result.supply_data.cups;
            document.getElementById('result-current-cost').textContent = result.supply_data.importe_total.toFixed(2) + 'â‚¬';
            
            // Calculate total consumption
            let totalConsumption = 0;
            if (result.tariffType === '2.0TD') {
                totalConsumption = (result.supply_data.consumo_punta || 0) +
                                 (result.supply_data.consumo_llano || 0) +
                                 (result.supply_data.consumo_valle || 0);
            } else {
                for (let i = 1; i <= 6; i++) {
                    totalConsumption += result.supply_data[`consumo_p${i}`] || 0;
                }
            }
            document.getElementById('result-total-consumption').textContent = totalConsumption.toFixed(2) + ' kWh';
            document.getElementById('result-billing-days').textContent = result.supply_data.dias_facturados || 30;
            
            // Generate tariff cards
            const container = document.getElementById('tariff-cards-container');
            container.innerHTML = '';
            
            result.results.forEach((tariff, index) => {
                const card = createTariffCard(tariff, index, result.supply_data.importe_total);
                container.appendChild(card);
            });
            
            // Scroll to results
            document.getElementById('results-view').scrollIntoView({ behavior: 'smooth' });
        }
        
        function createTariffCard(tariff, index, currentCost) {
            const card = document.createElement('div');
            const isBest = index === 0;
            const isDrk = tariff.isDrk;
            const savings = tariff.savings;
            const savingsPercentage = tariff.savings_percentage;
            
            // Determine card styling
            let cardClass = 'bg-white rounded-2xl shadow-lg p-6 border-2 transition-all hover:shadow-xl';
            let badgeClass = '';
            let badgeText = '';
            
            if (isBest) {
                cardClass += ' border-cta-green-500 ring-4 ring-cta-green-100';
                badgeClass = 'bg-cta-green-500 text-white';
                badgeText = 'ðŸ† Mejor OpciÃ³n';
            } else if (isDrk) {
                if (currentDisplayMode === 'DRK') {
                    cardClass += ' border-drk-500';
                    badgeClass = 'bg-drk-500 text-white';
                } else {
                    cardClass += ' border-powercup-500';
                    badgeClass = 'bg-powercup-500 text-white';
                }
                badgeText = currentDisplayMode === 'DRK' ? 'â­ DRK' : 'â­ PowerCup';
            } else {
                cardClass += ' border-slate-200';
                badgeClass = 'bg-slate-500 text-white';
                badgeText = 'Competencia';
            }
            
            card.className = cardClass;
            
            // Determine savings color
            const savingsColor = savings >= 0 ? 'text-cta-green-500' : 'text-cta-red-500';
            const savingsIcon = savings >= 0 ? 'ðŸ’°' : 'âš ï¸';
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-1">${tariff.name || 'Tarifa Sin Nombre'}</h3>
                        <p class="text-slate-600">${tariff.commercializer || 'Comercializadora'}</p>
                    </div>
                    <span class="${badgeClass} px-4 py-2 rounded-full text-sm font-bold">
                        ${badgeText}
                    </span>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-sm text-slate-600 mb-1">Coste Estimado</p>
                        <p class="text-2xl font-bold text-slate-800">${tariff.calculated_cost.toFixed(2)}â‚¬</p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-sm text-slate-600 mb-1">Ahorro vs Actual</p>
                        <p class="text-2xl font-bold ${savingsColor}">
                            ${savingsIcon} ${savings >= 0 ? '+' : ''}${savings.toFixed(2)}â‚¬
                        </p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-sm text-slate-600 mb-1">% Ahorro</p>
                        <p class="text-2xl font-bold ${savingsColor}">
                            ${savings >= 0 ? '+' : ''}${savingsPercentage.toFixed(1)}%
                        </p>
                    </div>
                </div>
                
                ${tariff.description ? `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <p class="text-sm text-blue-800">${tariff.description}</p>
                </div>
                ` : ''}
            `;
            
            return card;
        }

        // ===========================
        // PDF EXPORT
        // ===========================
        
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            try {
                // Capture the results section
                const resultsElement = document.getElementById('results-view');
                
                // Use html2canvas to capture
                const canvas = await html2canvas(resultsElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                // Add image to PDF
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Save PDF
                const filename = `comparacion_${currentTariffType}_${Date.now()}.pdf`;
                pdf.save(filename);
                
                showSuccessModal('PDF generado correctamente');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showErrorModal('Error al generar el PDF: ' + error.message);
            }
        }
        
        async function exportMultiCupsToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            try {
                const resultsElement = document.getElementById('multicups-results-container');
                const canvas = await html2canvas(resultsElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`comparacion_multicups_${Date.now()}.pdf`);
                
                showSuccessModal('PDF MultiCups generado correctamente');
                
            } catch (error) {
                console.error('Error generating MultiCups PDF:', error);
                showErrorModal('Error al generar el PDF: ' + error.message);
            }
        }

        // ===========================
        // APP RESET
        // ===========================
        
        function resetApp() {
            // Reset state
            lastComparisonResult = null;
            lastRawData = null;
            
            // Clear form
            document.getElementById('supply-form').reset();
            
            // Hide results, show input method selection
            document.getElementById('results-view').classList.add('hidden');
            showInputMethodSelection();
            
            // Clear QR
            const qrWrapper = document.getElementById('qr-content-wrapper');
            qrWrapper.classList.remove('active');
            document.getElementById('qrcode').innerHTML = '';
        }

        // ===========================
        // MULTICUPS SAGA
        // ===========================
        
        function showMultiCupsSagaView() {
            // Hide all other views
            document.getElementById('input-method-selection').classList.add('hidden');
            document.getElementById('manual-input-form').classList.add('hidden');
            document.getElementById('qr-input-section').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            
            // Show MultiCups view
            document.getElementById('multicups-saga-view').classList.remove('hidden');
            
            // Update display
            updateMultiCupsSagaView();
        }
        
        function updateMultiCupsSagaView() {
            // Update navbar badges and buttons
            const navArea = document.getElementById('multicups-saga-display-area');
            const tariffArea = document.getElementById('tariff-display-area');
            const count = document.getElementById('multicups-saga-count');
            const addBtn = document.getElementById('multicups-saga-add-supply-btn');
            const compareBtn = document.getElementById('multicups-saga-compare-btn');
            const loadingStatus = document.getElementById('loading-status-saga');
            
            if (currentTariffType === 'MULTICUPS') {
                navArea.classList.remove('hidden');
                tariffArea.classList.add('hidden');
                count.textContent = multiCupsSupplies.length;
                
                // Show/hide buttons based on tariffs loaded and supplies added
                const tariffsLoaded = currentTariffs['2.0TD'].length > 0 && currentTariffs['3.0TD'].length > 0;
                
                if (tariffsLoaded) {
                    loadingStatus.classList.add('hidden');
                    addBtn.classList.remove('hidden');
                    
                    // Show compare button only if at least one supply is added
                    if (multiCupsSupplies.length > 0) {
                        compareBtn.classList.remove('hidden');
                    } else {
                        compareBtn.classList.add('hidden');
                    }
                } else {
                    loadingStatus.classList.remove('hidden');
                    addBtn.classList.add('hidden');
                    compareBtn.classList.add('hidden');
                }
            } else {
                navArea.classList.add('hidden');
                tariffArea.classList.remove('hidden');
            }
        }
        
        function updateSingleTariffBadge() {
            const navArea = document.getElementById('multicups-saga-display-area');
            const tariffArea = document.getElementById('tariff-display-area');
            const badge = document.getElementById('tariff-display-badge');
            
            navArea.classList.add('hidden');
            tariffArea.classList.remove('hidden');
            
            const count = currentTariffs[currentTariffType]?.length || 0;
            badge.textContent = count;
        }
        
        function showSupplyInputMethodSelection() {
            // Show the input method selection for adding a new supply
            document.getElementById('multicups-results-container').classList.add('hidden');
            showInputMethodSelection();
        }
        
        function addSupplyToMultiCupsList(supplyResult) {
            // CRITICAL: When adding a supply from within saveSupply (which can be called from
            // processComparison in manual or QR flow), we must ensure that:
            // 1. The supply has the correct tariff type context
            // 2. We recalculate costs using the CORRECT tariff
            
            const tariffType = supplyResult._multiCupsContext?.tariffType || currentTariffType;
            const dataForCalc = supplyResult._multiCupsContext?.dataForCalc || supplyResult.supply_data;
            
            console.log('addSupplyToMultiCupsList called with tariffType:', tariffType, 'dataForCalc:', dataForCalc);
            
            // Get the tariffs for THIS specific supply's tariff type
            const tariffs = currentTariffs[tariffType];
            if (!tariffs || tariffs.length === 0) {
                showErrorModal(`No hay tarifas cargadas para ${tariffType}`);
                return;
            }
            
            // RECALCULATE costs for this supply using its CORRECT tariff type
            const results = tariffs.map(tariff => {
                const cost = calculateTariffCost(dataForCalc, tariff, tariffType);
                return {
                    ...tariff,
                    calculated_cost: cost,
                    savings: dataForCalc.importe_total - cost,
                    savings_percentage: ((dataForCalc.importe_total - cost) / dataForCalc.importe_total * 100)
                };
            });
            
            // Sort by cost
            results.sort((a, b) => a.calculated_cost - b.calculated_cost);
            
            // Create the complete supply result object with RECALCULATED results
            const completeResult = {
                supply_data: dataForCalc,
                results: results,
                tariffType: tariffType,
                isMulti: true,
                _multiCupsContext: {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                }
            };
            
            // Add to list
            multiCupsSupplies.push(completeResult);
            
            console.log('Supply added to multiCupsSupplies:', completeResult);
            
            // Update UI
            renderMultiCupsSuppliesList();
            updateMultiCupsSagaView();
            
            // Show success message
            showSuccessModal(`Suministro ${tariffType} aÃ±adido correctamente (${multiCupsSupplies.length} total)`);
        }
        
        function renderMultiCupsSuppliesList() {
            const listContainer = document.getElementById('multicups-supplies-list');
            listContainer.innerHTML = '';
            
            if (multiCupsSupplies.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <p class="text-lg">No hay suministros agregados</p>
                        <p class="text-sm mt-2">Usa el botÃ³n "AÃ±adir Suministro" para empezar</p>
                    </div>
                `;
                return;
            }
            
            multiCupsSupplies.forEach((supply, index) => {
                const card = document.createElement('div');
                card.className = 'bg-slate-50 rounded-xl p-4 border-2 border-slate-200 hover:border-drk-500 transition-all';
                
                const totalConsumption = calculateTotalConsumption(supply.supply_data, supply.tariffType);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="bg-drk-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                    ${supply.tariffType}
                                </span>
                                <span class="font-mono text-sm text-slate-600">${supply.supply_data.cups}</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-slate-600">Importe:</span>
                                    <span class="font-semibold ml-1">${supply.supply_data.importe_total.toFixed(2)}â‚¬</span>
                                </div>
                                <div>
                                    <span class="text-slate-600">Consumo:</span>
                                    <span class="font-semibold ml-1">${totalConsumption.toFixed(2)} kWh</span>
                                </div>
                                <div>
                                    <span class="text-slate-600">DÃ­as:</span>
                                    <span class="font-semibold ml-1">${supply.supply_data.dias_facturados || 30}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="removeSupply(${index})" class="ml-4 p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(card);
            });
        }
        
        function calculateTotalConsumption(supplyData, tariffType) {
            let total = 0;
            if (tariffType === '2.0TD') {
                total = (supplyData.consumo_punta || 0) +
                       (supplyData.consumo_llano || 0) +
                       (supplyData.consumo_valle || 0);
            } else {
                for (let i = 1; i <= 6; i++) {
                    total += supplyData[`consumo_p${i}`] || 0;
                }
            }
            return total;
        }
        
        function removeSupply(index) {
            multiCupsSupplies.splice(index, 1);
            renderMultiCupsSuppliesList();
            updateMultiCupsSagaView();
        }
        
        function performMultiCupsSagaComparison() {
            if (multiCupsSupplies.length === 0) {
                showErrorModal('No hay suministros para comparar');
                return;
            }
            
            console.log('Starting MultiCups comparison with', multiCupsSupplies.length, 'supplies');
            
            // --- NUEVA LÃ“GICA: Mostrar modal de decisiÃ³n ---
            // Contar cuÃ¡ntas ofertas hay en total (uniÃ³n de ambas tarifas)
            const all2TDOffers = currentTariffs['2.0TD'] || [];
            const all3TDOffers = currentTariffs['3.0TD'] || [];
            
            // Crear un Set para evitar duplicados (por si una oferta estÃ¡ en ambas)
            const allOffersSet = new Set();
            [...all2TDOffers, ...all3TDOffers].forEach(offer => {
                allOffersSet.add(JSON.stringify(offer)); // Usar JSON para comparar objetos
            });
            const allOffersCount = allOffersSet.size;
            
            // Contar ofertas DRK
            const drkOffersCount = [...all2TDOffers, ...all3TDOffers].filter(offer => offer.isDrk).length;
            
            // Si hay mÃ¡s de 1 oferta en total, mostrar el modal de decisiÃ³n
            if (allOffersCount > 1) {
                // Guardar el contexto para usar despuÃ©s de que el usuario decida
                availableOffers = Array.from(allOffersSet).map(s => JSON.parse(s));
                
                // Actualizar el modal con los conteos
                document.getElementById('offer-count-text').textContent = allOffersCount;
                document.getElementById('all-offers-count').textContent = allOffersCount;
                document.getElementById('drk-offers-count').textContent = drkOffersCount;
                
                // Mostrar el modal
                showOfferDecisionModal();
            } else {
                // Solo hay 1 oferta o ninguna, proceder directamente
                selectedOfferSet = 'ALL';
                continueMultiCupsComparison();
            }
        }
        
        function showOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.remove('hidden');
        }
        
        function closeOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.add('hidden');
        }
        
        function chooseAllOffers() {
            selectedOfferSet = 'ALL';
            closeOfferDecisionModal();
            
            // Si estamos en el contexto de MultiCups Saga, continuar la comparaciÃ³n
            if (multiCupsSupplies.length > 0) {
                continueMultiCupsComparison();
            } else if (lastComparisonResult && lastComparisonResult._multiCupsContext) {
                // Estamos en el contexto de un suministro individual aÃ±adido desde saveSupply
                const context = lastComparisonResult._multiCupsContext;
                const tariffType = context.tariffType;
                const dataForCalc = context.dataForCalc;
                
                // Recalcular con TODAS las ofertas
                const tariffs = currentTariffs[tariffType];
                const results = tariffs.map(tariff => {
                    const cost = calculateTariffCost(dataForCalc, tariff, tariffType);
                    return {
                        ...tariff,
                        calculated_cost: cost,
                        savings: dataForCalc.importe_total - cost,
                        savings_percentage: ((dataForCalc.importe_total - cost) / dataForCalc.importe_total * 100)
                    };
                });
                results.sort((a, b) => a.calculated_cost - b.calculated_cost);
                
                lastComparisonResult.results = results;
                lastComparisonResult.supply_data = dataForCalc;
                lastComparisonResult.tariffType = tariffType;
                
                // AÃ±adir a la lista de MultiCups
                addSupplyToMultiCupsList(lastComparisonResult);
            }
        }
        
        function chooseDrkOffersOnly() {
            selectedOfferSet = 'DRK_ONLY';
            closeOfferDecisionModal();
            
            if (multiCupsSupplies.length > 0) {
                continueMultiCupsComparison();
            } else if (lastComparisonResult && lastComparisonResult._multiCupsContext) {
                const context = lastComparisonResult._multiCupsContext;
                const tariffType = context.tariffType;
                const dataForCalc = context.dataForCalc;
                
                // Filtrar solo ofertas DRK
                const tariffs = currentTariffs[tariffType].filter(t => t.isDrk);
                
                if (tariffs.length === 0) {
                    showErrorModal('No hay ofertas DRK disponibles para esta tarifa');
                    return;
                }
                
                const results = tariffs.map(tariff => {
                    const cost = calculateTariffCost(dataForCalc, tariff, tariffType);
                    return {
                        ...tariff,
                        calculated_cost: cost,
                        savings: dataForCalc.importe_total - cost,
                        savings_percentage: ((dataForCalc.importe_total - cost) / dataForCalc.importe_total * 100)
                    };
                });
                results.sort((a, b) => a.calculated_cost - b.calculated_cost);
                
                lastComparisonResult.results = results;
                lastComparisonResult.supply_data = dataForCalc;
                lastComparisonResult.tariffType = tariffType;
                
                addSupplyToMultiCupsList(lastComparisonResult);
            }
        }
        
        function continueMultiCupsComparison() {
            console.log('Continuing MultiCups comparison with offer set:', selectedOfferSet);
            
            // Para cada suministro, encontrar la mejor oferta segÃºn el filtro seleccionado
            multiCupsBestOffersPerSupply = [];
            
            multiCupsSupplies.forEach((supply, index) => {
                console.log(`Processing supply ${index + 1} of ${multiCupsSupplies.length}`);
                console.log('Supply tariff type:', supply.tariffType);
                console.log('Supply data:', supply.supply_data);
                
                // CRÃTICO: Usar el tariffType y dataForCalc del contexto del suministro
                const tariffType = supply._multiCupsContext?.tariffType || supply.tariffType;
                const dataForCalc = supply._multiCupsContext?.dataForCalc || supply.supply_data;
                
                console.log('Using tariffType:', tariffType, 'dataForCalc:', dataForCalc);
                
                // Obtener las tarifas correctas para ESTE suministro
                let relevantTariffs = currentTariffs[tariffType] || [];
                
                console.log(`Found ${relevantTariffs.length} tariffs for ${tariffType}`);
                
                // Filtrar segÃºn la elecciÃ³n del usuario
                if (selectedOfferSet === 'DRK_ONLY') {
                    relevantTariffs = relevantTariffs.filter(t => t.isDrk);
                    console.log(`After DRK filter: ${relevantTariffs.length} tariffs`);
                }
                
                if (relevantTariffs.length === 0) {
                    console.warn(`No tariffs available for supply ${index + 1} (${tariffType})`);
                    return;
                }
                
                // RECALCULAR los costes para ESTE suministro con sus tarifas correctas
                const results = relevantTariffs.map(tariff => {
                    const cost = calculateTariffCost(dataForCalc, tariff, tariffType);
                    console.log(`Tariff ${tariff.name}: cost = ${cost.toFixed(2)}`);
                    return {
                        ...tariff,
                        calculated_cost: cost,
                        savings: dataForCalc.importe_total - cost,
                        savings_percentage: ((dataForCalc.importe_total - cost) / dataForCalc.importe_total * 100)
                    };
                });
                
                // Ordenar por coste
                results.sort((a, b) => a.calculated_cost - b.calculated_cost);
                
                console.log(`Best offer for supply ${index + 1}: ${results[0].name} at ${results[0].calculated_cost.toFixed(2)}â‚¬`);
                
                // Guardar la mejor oferta para este suministro
                multiCupsBestOffersPerSupply.push({
                    supply: dataForCalc,
                    tariffType: tariffType,
                    bestOffer: results[0],
                    allOffers: results
                });
            });
            
            console.log('Best offers per supply:', multiCupsBestOffersPerSupply);
            
            // Mostrar resultados
            displayMultiCupsResults();
        }
        
        function displayMultiCupsResults() {
            console.log('Displaying MultiCups results');
            
            // Hide supplies list, show results
            document.getElementById('multicups-results-container').classList.remove('hidden');
            
            // Calculate totals
            let totalCurrentCost = 0;
            let totalNewCost = 0;
            
            multiCupsBestOffersPerSupply.forEach(item => {
                totalCurrentCost += item.supply.importe_total || 0;
                totalNewCost += item.bestOffer.calculated_cost || 0;
            });
            
            const totalSavings = totalCurrentCost - totalNewCost;
            
            console.log('Total current cost:', totalCurrentCost);
            console.log('Total new cost:', totalNewCost);
            console.log('Total savings:', totalSavings);
            
            // Update summary
            document.getElementById('multi-total-supplies').textContent = multiCupsSupplies.length;
            document.getElementById('multi-current-total').textContent = totalCurrentCost.toFixed(2) + 'â‚¬';
            document.getElementById('multi-savings-total').textContent = totalSavings >= 0 ? '+' + totalSavings.toFixed(2) + 'â‚¬' : totalSavings.toFixed(2) + 'â‚¬';
            
            // Find the most common best offer (the one that appears most across supplies)
            const offerCounts = {};
            multiCupsBestOffersPerSupply.forEach(item => {
                const offerKey = item.bestOffer.name;
                offerCounts[offerKey] = (offerCounts[offerKey] || 0) + 1;
            });
            
            let mostCommonOffer = null;
            let maxCount = 0;
            Object.entries(offerCounts).forEach(([name, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostCommonOffer = name;
                }
            });
            
            console.log('Most common offer:', mostCommonOffer, 'appears', maxCount, 'times');
            
            // Display best offer card
            const bestOfferCard = document.getElementById('multicups-best-offer-card');
            const bestOffer = multiCupsBestOffersPerSupply[0]?.bestOffer;
            
            if (bestOffer) {
                bestOfferCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold">ðŸ† Mejor Oferta Global</h3>
                        <span class="bg-white/20 px-4 py-2 rounded-full text-sm font-bold">
                            Ahorro Total: ${totalSavings >= 0 ? '+' : ''}${totalSavings.toFixed(2)}â‚¬
                        </span>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 mb-4">
                        <h4 class="text-xl font-bold mb-2">${mostCommonOffer || bestOffer.name}</h4>
                        <p class="text-white/80 mb-4">${bestOffer.description || ''}</p>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <p class="text-white/70 text-sm mb-1">Coste Total Nuevo</p>
                                <p class="text-2xl font-bold">${totalNewCost.toFixed(2)}â‚¬</p>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm mb-1">Coste Actual</p>
                                <p class="text-2xl font-bold">${totalCurrentCost.toFixed(2)}â‚¬</p>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm mb-1">Suministros Cubiertos</p>
                                <p class="text-2xl font-bold">${multiCupsSupplies.length}</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-white/90 text-sm">
                        Esta oferta ha sido seleccionada como la mejor opciÃ³n para tus ${multiCupsSupplies.length} suministros.
                    </p>
                `;
            }
            
            // Display individual results
            const individualResults = document.getElementById('multicups-individual-results');
            individualResults.innerHTML = '';
            
            multiCupsBestOffersPerSupply.forEach((item, index) => {
                console.log(`Creating card for supply ${index + 1}:`, item);
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-lg p-6';
                
                const totalConsumption = calculateTotalConsumption(item.supply, item.tariffType);
                const savings = item.supply.importe_total - item.bestOffer.calculated_cost;
                const savingsColor = savings >= 0 ? 'text-cta-green-500' : 'text-cta-red-500';
                
                console.log(`Supply ${index + 1} - Current: ${item.supply.importe_total}, New: ${item.bestOffer.calculated_cost}, Savings: ${savings}`);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-xl font-bold text-slate-800">Suministro ${index + 1}</h4>
                        <span class="bg-drk-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                            ${item.tariffType}
                        </span>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-slate-50 rounded-xl p-4">
                            <p class="text-sm text-slate-600 mb-2">Datos del Suministro</p>
                            <p class="text-xs text-slate-500 font-mono mb-1">${item.supply.cups}</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="text-slate-600">Consumo:</span>
                                    <span class="font-semibold ml-1">${totalConsumption.toFixed(2)} kWh</span>
                                </div>
                                <div>
                                    <span class="text-slate-600">DÃ­as:</span>
                                    <span class="font-semibold ml-1">${item.supply.dias_facturados || 30}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 rounded-xl p-4">
                            <p class="text-sm text-slate-600 mb-2">ComparaciÃ³n de Costes</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="text-slate-600">Actual:</span>
                                    <span class="font-semibold ml-1">${item.supply.importe_total.toFixed(2)}â‚¬</span>
                                </div>
                                <div>
                                    <span class="text-slate-600">Nuevo:</span>
                                    <span class="font-semibold ml-1">${item.bestOffer.calculated_cost.toFixed(2)}â‚¬</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-slate-600">Ahorro:</span>
                                    <span class="font-bold ${savingsColor} ml-1">
                                        ${savings >= 0 ? '+' : ''}${savings.toFixed(2)}â‚¬
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-drk-50 to-drk-100 rounded-xl p-4">
                        <p class="text-sm font-semibold text-drk-800 mb-2">Mejor Oferta: ${item.bestOffer.name}</p>
                        <p class="text-xs text-drk-700">${item.bestOffer.commercializer || ''}</p>
                        ${item.bestOffer.description ? `<p class="text-xs text-drk-600 mt-2">${item.bestOffer.description}</p>` : ''}
                    </div>
                `;
                
                individualResults.appendChild(card);
            });
            
            // Scroll to results
            document.getElementById('multicups-results-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetMultiCupsSaga() {
            // Clear all supplies
            multiCupsSupplies = [];
            multiCupsBestOffersPerSupply = [];
            selectedOfferSet = 'ALL';
            
            // Hide results, show supplies list
            document.getElementById('multicups-results-container').classList.add('hidden');
            renderMultiCupsSuppliesList();
            updateMultiCupsSagaView();
            
            showSuccessModal('MultiCups reiniciado');
        }

        // ===========================
        // MODALS
        // ===========================
        
        function showErrorModal(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }
        
        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
        }
        
        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').classList.remove('hidden');
        }
        
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
        }
        
        // Make showErrorModal available globally
        window.showErrorModal = showErrorModal;

        // ===========================
        // MULTICUPS SUPPLY SAVING
        // ===========================
        
        function saveSupply(data, results) {
            // This function is called when adding a supply to MultiCups
            // It should prepare the supply for addition to the list
            
            // CRÃTICO: Preservar el tipo de tarifa Y los datos usados para el cÃ¡lculo
            const tariffType = currentTariffType === 'MULTICUPS' ? 
                              (data.consumo_punta !== undefined ? '2.0TD' : '3.0TD') : 
                              currentTariffType;
            
            console.log('saveSupply called with tariffType:', tariffType);
            console.log('Data:', data);
            
            // Crear una copia de los datos para asegurar que tenemos todos los campos necesarios
            let dataForCalc = {...data};
            
            // Si es 3.0TD pero solo tenemos datos de 2.0TD, necesitamos convertir
            if (tariffType === '3.0TD' && data.consumo_punta !== undefined) {
                console.log('Converting 2.0TD data to 3.0TD format for calculation');
                
                // CONVERSIÃ“N INTELIGENTE DE 2.0TD A 3.0TD
                // DistribuciÃ³n horaria tÃ­pica en EspaÃ±a:
                // P1 (punta): ~8% del consumo total (horas pico 10-14h y 18-22h laborables)
                // P2 (llano): ~30% del consumo total (horas llano laborables)
                // P3 (llano): ~25% del consumo total (horas valle laborables y punta fines de semana)
                // P4 (valle): ~12% del consumo total (horas llano fines de semana)
                // P5 (valle): ~15% del consumo total (horas valle fines de semana)
                // P6 (super valle): ~10% del consumo total (madrugada todos los dÃ­as)
                
                const totalConsumo = (data.consumo_punta || 0) + (data.consumo_llano || 0) + (data.consumo_valle || 0);
                
                // Asignar consumos segÃºn la distribuciÃ³n horaria tÃ­pica
                dataForCalc.consumo_p1 = totalConsumo * 0.08;  // Punta laborable
                dataForCalc.consumo_p2 = totalConsumo * 0.30;  // Llano laborable
                dataForCalc.consumo_p3 = totalConsumo * 0.25;  // Valle laborable / Punta fin de semana
                dataForCalc.consumo_p4 = totalConsumo * 0.12;  // Llano fin de semana
                dataForCalc.consumo_p5 = totalConsumo * 0.15;  // Valle fin de semana
                dataForCalc.consumo_p6 = totalConsumo * 0.10;  // Super valle (madrugada)
                
                // Para potencia, usar un valor razonable basado en el consumo
                // Normalmente, la potencia contratada es ~1.5-2x el consumo medio horario
                const avgHourlyConsumption = totalConsumo / ((data.dias_facturados || 30) * 24);
                const estimatedPower = avgHourlyConsumption * 1.8; // Factor tÃ­pico
                
                // Asignar la misma potencia a todos los periodos (simplificaciÃ³n comÃºn en 3.0TD)
                for (let i = 1; i <= 6; i++) {
                    dataForCalc[`potencia_p${i}_kw`] = estimatedPower;
                }
                
                console.log('Converted to 3.0TD:', dataForCalc);
            }
            
            // Preparar el resultado final que incluirÃ¡ TODA la informaciÃ³n necesaria
            let finalIndividualResult = {
                supply_data: data, // Datos originales del suministro
                results: results,  // Resultados de comparaciÃ³n
                tariffType: tariffType,
                isMulti: false // Indicar que es un suministro individual dentro de MultiCups
            };
            
            // Copiar datos base del suministro (CUPS, dÃ­as facturados, importe, etc.)
            finalIndividualResult.cups = data.cups || '';
            finalIndividualResult.importe_total = data.importe_total || 0;
            finalIndividualResult.dias_facturados = data.dias_facturados || 30;

            // Copy back the 6-period power and consumption values in case they were generated (for 3.0TD)
            if (tariffType === '3.0TD') {
                for (let i = 1; i <= 6; i++) {
                    finalIndividualResult[`consumo_p${i}`] = dataForCalc[`consumo_p${i}`] || 0;
                    finalIndividualResult[`potencia_p${i}_kw`] = dataForCalc[`potencia_p${i}_kw`] || 0;
                }
            } else if (tariffType === '2.0TD') {
                // Para 2.0TD tambiÃ©n copiar los datos
                finalIndividualResult.consumo_punta = dataForCalc.consumo_punta || 0;
                finalIndividualResult.consumo_llano = dataForCalc.consumo_llano || 0;
                finalIndividualResult.consumo_valle = dataForCalc.consumo_valle || 0;
                finalIndividualResult.potencia_p1_kw = dataForCalc.potencia_p1_kw || 0;
                finalIndividualResult.potencia_p2_kw = dataForCalc.potencia_p2_kw || 0;
            }
            
            // --- NUEVA LÃ“GICA: Modal de decisiÃ³n en MultiCups (TODOS LOS MODOS) ---
            // Si hay mÃ¡s de 1 oferta, permitir elegir (en cualquier modo)
            if (availableOffers.length > 1) {
                console.log('MultiCups: Showing decision modal with', availableOffers.length, 'offers');
                
                // Guardar temporalmente el resultado para usarlo despuÃ©s
                lastComparisonResult = finalIndividualResult;
                lastComparisonResult.isMulti = false;
                lastComparisonResult._multiCupsContext = {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                };
                
                // Mostrar modal de decisiÃ³n
                showOfferDecisionModal();
                return; // No aÃ±adir todavÃ­a, esperar decisiÃ³n del usuario
            }
            
            // AÃ±adir directamente si solo hay 1 oferta o ninguna
            // CRÃTICO: Asegurar que el resultado tenga el contexto MULTICUPS
            finalIndividualResult._multiCupsContext = {
                tariffType: tariffType,
                dataForCalc: dataForCalc
            };
            
            // IMPORTANTE: Usar addSupplyToMultiCupsList para que recalcule costes correctamente
            addSupplyToMultiCupsList(finalIndividualResult);
            
            // La funciÃ³n addSupplyToMultiCupsList ya actualiza la UI, pero como estamos
            // en saveSupply, NO llamamos a showMultiCupsSagaView aquÃ­
            // (se llama dentro de addSupplyToMultiCupsList)
            return; // Salir para no ejecutar cÃ³digo duplicado
        }

        // --- FETCH & PARSE (Actualizado para MÃºltiples Tarifas) ---

        async function fetchTariffsForMultiCups() {
            const statusEl = document.getElementById('loading-status-saga');
            statusEl.textContent = `Cargando tarifas 2.0TD y 3.0TD...`;
            updateMultiCupsSagaView(); // Update visibility to show loading
            
            // Fetch 2.0TD and 3.0TD tariffs simultaneously
            await Promise.all([
                fetchTariffsFromSheet('2.0TD'),
                fetchTariffsFromSheet('3.0TD')  
            ]);
            
            updateMultiCupsSagaView(); // Update visibility to hide loading and enable buttons
            
            if (currentTariffs['2.0TD'].length === 0 || currentTariffs['3.0TD'].length === 0) {
                 // Use a more specific error message based on which failed
                 const failed = [];
                 if (currentTariffs['2.0TD'].length === 0) failed.push('2.0TD');
                 if (currentTariffs['3.0TD'].length === 0) failed.push('3.0TD');
                 window.showErrorModal(`Error: Las tarifas ${failed.join(' y ')} para MultiCups no se han cargado correctamente. Intente de nuevo.`);
            }
        }
        
        async function fetchTariffsFromSheet(tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            const sheetId = config.sheetId;

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error red para ${tariffType}`);
                const text = await response.text();
                currentTariffs[tariffType] = parseCSV(text, tariffType);
                
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    const count = currentTariffs[currentTariffType].length;
                    document.getElementById('tariff-display-badge').textContent = count;
                }

            } catch (e) {
                console.error(`Error al cargar ${tariffType}:`, e);
                currentTariffs[tariffType] = [];  
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('tariff-display-badge').textContent = 'Error';
                }
            } finally {
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('loading-status').classList.add('hidden');
                }
            }
        }

        function parseCSV(text, tariffType) {
             const lines = text.trim().split('\n');
             if (lines.length < 2) return [];
             
             const rawHeader = lines[0];
             const delimiter = rawHeader.includes(';') ? ';' : ',';
             
             const headers = rawHeader.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
             const data = [];

             for(let i=1; i<lines.length; i++) {
                 const row = lines[i].trim();
                 if(!row) continue;
                 
                 const regex = new RegExp(`(?:^|${delimiter})(\"(?:[^\"]|\"\")*\"|[^${delimiter}]*)`,"g");
                 const values = [];
                 let match = null;
                 regex.lastIndex = 0;  
                 // Custom parsing to handle quoted fields correctly
                 let lastIndex = 0;
                 while(match = regex.exec(row)){
                      let val = match[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                      // If the first capture group starts with the delimiter, it means the content is empty or the previous field was empty.
                      if (match.index > lastIndex) {
                           // Add empty string for missed fields
                           for (let j = 0; j < (match.index - lastIndex) / delimiter.length; j++) {
                                values.push('');
                           }
                      }
                      values.push(val.trim());
                      lastIndex = match.index + match[0].length;
                 }
                 // Add trailing empty fields
                 if (values.length < headers.length) {
                      for (let j = values.length; j < headers.length; j++) {
                           values.push('');
                      }
                 }


                 if(values.length < headers.length) continue;

                 let item = { cups_match: [tariffType] };
                 headers.forEach((h, idx) => {
                      let val = values[idx];
                       if (h.includes('price') || h.includes('potencia') || h === 'descuento') {
                            val = parseFloat(val?.replace(',', '.') || 0);
                             if(isNaN(val)) val = 0;
                       }
                       item[h] = val;
                 });

                 // Marcar como DRK si el nombre O la descripciÃ³n O commercializer contienen "DRK"
                 item.isDrk = item.name?.toUpperCase().includes('DRK') || 
                              item.description?.toUpperCase().includes('DRK') ||
                              item.commercializer?.toUpperCase().includes('DRK');
                 
                 // Check a mandatory field to ensure it's a valid row (using p1_price as a key indicator)
                 if(item.p1_price !== undefined) {
                     data.push(item);
                 }
               }
               return data;
        }
    </script>
</body>
</html>
